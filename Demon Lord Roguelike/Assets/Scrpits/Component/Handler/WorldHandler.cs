using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class WorldHandler : BaseHandler<WorldHandler, WorldManager>
{
    //当前战斗场景
    public GameObject currentFightScene;
    //基地场景
    public GameObject currentBaseScene;

    public void EnterGameForBaseScene(UserDataBean userData,bool isInitScene)
    {
        Action actionForStart = () =>
        {
            //镜头初始化
            CameraHandler.Instance.InitData();
            //环境参数初始化
            VolumeHandler.Instance.InitData(GameSceneTypeEnum.Base);
            //设置基地场景视角
            CameraHandler.Instance.InitBaseSceneControlCamera(() =>
            {
                //关闭LoadingUI
                var uiBaseMain = UIHandler.Instance.OpenUIAndCloseOther<UIBaseMain>();
            }, userData.selfCreature);
        };
        if (isInitScene)
        {
            //清理世界数据
            ClearWorldData(() =>
            {                   
                //加载基地场景
                LoadBaseScene((targetObj) =>
                {
                    actionForStart?.Invoke();
                });
            });
        }
        else
        {
            actionForStart?.Invoke();
        }
    }

    public void EnterMainForBaseScene()
    {
        ClearWorldData(() =>
        {
            //打开加载UI
            UIHandler.Instance.OpenUIAndCloseOther<UICommonLoading>();
            //镜头初始化
            CameraHandler.Instance.InitData();
            //环境参数初始化
            VolumeHandler.Instance.InitData(GameSceneTypeEnum.Base);
            //加载基地场景
            LoadBaseScene((targetObj) =>
            {
                //关闭LoadingUI 打开开始UI
                UIHandler.Instance.OpenUIAndCloseOther<UIMainStart>();
            });
        });
    }

    /// <summary>
    /// 加载基地场景
    /// </summary>
    /// <param name="actionForComplete"></param>
    public void LoadBaseScene(Action<GameObject> actionForComplete)
    {
        UnLoadBaseScene();
        manager.GetBaseScene((targetScene) =>
        {
            currentBaseScene = Instantiate(targetScene);
            currentBaseScene.SetActive(true);
            currentBaseScene.transform.position = Vector3.zero;
            currentBaseScene.transform.eulerAngles = Vector3.zero;
            actionForComplete?.Invoke(currentBaseScene);
        });
    }

    /// <summary>
    /// 加载战斗场景
    /// </summary>
    public void LoadFightScene(int fightSceneId, Action<GameObject> actionForComplete)
    {
        UnLoadFightScene();
        manager.GetFightScene(fightSceneId, (targetScene) =>
        {
            currentFightScene = Instantiate(targetScene);
            currentFightScene.SetActive(true);
            currentFightScene.transform.position = Vector3.zero;
            currentFightScene.transform.eulerAngles = Vector3.zero;
            actionForComplete?.Invoke(currentFightScene);
        });
    }

    /// <summary>
    /// 卸载战斗场景
    /// </summary>
    public void UnLoadFightScene()
    {
        if (currentFightScene != null)
        {
            DestroyImmediate(currentFightScene);
        }
    }

    /// <summary>
    /// 卸载基地场景
    /// </summary>
    public void UnLoadBaseScene()
    {
        if (currentBaseScene != null)
        {
            DestroyImmediate(currentBaseScene);
        }
    }

    /// <summary>
    /// 清理世界所有数据
    /// </summary>
    public async void ClearWorldData(Action actionForComplete,bool isShowLoading = true)
    {      
        //打开加载UI
        if(isShowLoading)
            UIHandler.Instance.OpenUIAndCloseOther<UICommonLoading>();
        //关闭所有控制
        GameControlHandler.Instance.manager.EnableAllControl(false);

        await new WaitNextFrame();
        UnLoadBaseScene();
        await new WaitNextFrame();
        //logic清理
        BaseGameLogic gameLogic =  GameHandler.Instance.manager.GetGameLogic<BaseGameLogic>();
        if (gameLogic != null)
        {
            gameLogic.ClearGame();
        }
        await new WaitNextFrame();
        //清理粒子
        EffectHandler.Instance.manager.Clear();
        await new WaitNextFrame();
        //清理缓存
        System.GC.Collect();
        await new WaitNextFrame();
        actionForComplete?.Invoke();
    }
}
